<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Intro to spanishRshapes package • spanishRshapes</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">spanishRshapes</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/intro-to-spanishrshapes.html">Intro to spanishRshapes package</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/perezp44/spanishRshapes">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Intro to spanishRshapes package</h1>
                        <h4 class="author">Pedro J. Pérez</h4>
            
            <h4 class="date">2018-02-06</h4>
          </div>

    
    
<div class="contents">
<p><code>spanishRshapes</code> es un pacakge de datos. su unica finalidad es facilitar el uso de las geometrias espaciales para municipios, provincias y CC.AA españolas procedentes del IGN en R.</p>
<p>A continuación decribiré el proceso de descarga/procesado de los datos</p>
<div id="intro-y-descarga-del-ign" class="section level2">
<h2 class="hasAnchor">
<a href="#intro-y-descarga-del-ign" class="anchor"></a>Intro y descarga del IGN</h2>
<p>Estoy jugando con un blog y estoy haciendo mapas de los municipios españoles, así que me he decidido a actualizar mi fichero de <em>shapes</em>. Para ello toca ir a la web del <a href="http://www.ign.es/web/ign/portal">Instituto Geográfico Nacional</a>, concretamente al <a href="http://centrodedescargas.cnig.es/CentroDescargas/index.jsp">centro de descargas</a>. Una vez en el centro de descargas, hemos de ir a <code>Información geográfica de referencia</code> y luego a <code>Lineas límite municipales</code>. Trabajaré con los ficheros de “recintos”. Veamoslo:</p>
<p><img src="images/CNIG_1.PNG" width="288"><img src="images/CNIG_2.PNG" width="276"></p>
<p>Al pinchar en <code>Descargar</code>, se descarga un fichero zip. Yo lo descargué el <strong>27 de enero de 2018</strong>. Al descomprimirlo aparecen muchas carpetas: lineas y recintos para municipios, provincias y CC. AA.; además Canarias va aparte. Veámoslo:</p>
<p><img src="images/vista_shapes.png" width="298"></p>
<p><br></p>
<p>Trabajaré con los ficheros de “recintos”. Primero los recintos de las CC.AA.</p>
<p><br></p>
</div>
<div id="lindes-de-cc-aa-" class="section level2">
<h2 class="hasAnchor">
<a href="#lindes-de-cc-aa-" class="anchor"></a>Lindes de CC.AA.</h2>
<p>En España hay dieciséis comunidades autónomas y una comunidad foral (Navarra), además de Ceuta y Melilla, cuyos estatutos de autonomía les otorgan el rango de ciudades autónomas; así que a partir de ahora diremos que hay 19 CC.AA.</p>
<p>Cargo los datos con el paquete <a href="https://cran.r-project.org/web/packages/sf/index.html">sf</a>.</p>
<pre><code>#&gt; Warning: package 'tidyverse' was built under R version 3.4.3
#&gt; -- Attaching packages --------------------------------------------------------------- tidyverse 1.2.1 --
#&gt; v ggplot2 2.2.1.9000     v purrr   0.2.4     
#&gt; v tibble  1.4.2          v dplyr   0.7.4     
#&gt; v tidyr   0.8.0          v stringr 1.2.0     
#&gt; v readr   1.1.1          v forcats 0.2.0
#&gt; Warning: package 'tidyr' was built under R version 3.4.3
#&gt; Warning: package 'purrr' was built under R version 3.4.3
#&gt; Warning: package 'dplyr' was built under R version 3.4.2
#&gt; -- Conflicts ------------------------------------------------------------------ tidyverse_conflicts() --
#&gt; x dplyr::filter() masks stats::filter()
#&gt; x dplyr::lag()    masks stats::lag()
#&gt; Warning: package 'sf' was built under R version 3.4.3
#&gt; Linking to GEOS 3.6.1, GDAL 2.2.0, proj.4 4.9.3
#&gt; here() starts at C:/Users/perezp/Desktop/a_GIT_2016a/spanishRshapes</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)
<span class="kw">library</span>(sf)
<span class="kw">library</span>(here)
aa &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="kw">here</span>(), <span class="st">"./data_IGN/lineas_limite/recintos_autonomicas_inspire_peninbal_etrs89/recintos_autonomicas_inspire_peninbal_etrs89.shp"</span>)
ccaa_sf &lt;-<span class="st"> </span><span class="kw">st_read</span>(aa) <span class="co">#- 18 registros en Peninsula</span>
aa &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="kw">here</span>(), <span class="st">"./data_IGN/lineas_limite/recintos_autonomicas_inspire_canarias_wgs84/recintos_autonomicas_inspire_canarias_wgs84.shp"</span>)
ccaa_can_sf &lt;-<span class="st"> </span><span class="kw">st_read</span>(aa)  <span class="co">#- 1 registo en Canarias</span></code></pre></div>
<p>Como ya dije los polígonos/shapes de Canarias van en fichero aparte y además resulta que están en <a href="https://en.wikipedia.org/wiki/Spatial_reference_system">coordinate reference system</a> (CRS) diferentes. La península está en <code>epsg (SRID): 4258</code> mientras que Canarias está en <code>epsg (SRID): 4326</code>; así que antes de fusionar los dos ficheros, transformaré el de Canarias con <code><a href="http://www.rdocumentation.org/packages/sf/topics/st_transform">sf::st_transform()</a></code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ccaa_can_sf&lt;-<span class="st"> </span><span class="kw">st_transform</span>(ccaa_can_sf, <span class="dv">4258</span>) <span class="co">#- convierto de epsg(SRID):4326   a  epsg(SRID): 4258</span></code></pre></div>
<p>Bien, sólo queda unir los dos conjuntos de shapes, lo haré con <code>rbind(..., deparse.level = 1)</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#- para unirlos hay q usar rbind(..., deparse.level = 1)</span>
ccaa_todas &lt;-<span class="st"> </span><span class="kw">rbind</span>(ccaa_sf, ccaa_can_sf, <span class="dt">deparse.level =</span> <span class="dv">1</span>) <span class="co">#- 19 registros</span></code></pre></div>
<p>Bueno, ya tengo en un único objeto (<code>ccaa_todas</code>) los shapes de las 19 CC.AA en el mismo CRS, sólo quedaría grabarlo en formato .rds; pero antes quiero añadirle los códigos INE para las CC.AA. Para ello, primero he de sacar el código de la CC.AA de la variable NATCODE:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ccaa_todas &lt;-<span class="st"> </span>ccaa_todas <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">INECodCCAA =</span> <span class="kw">str_extract</span>(NATCODE, <span class="st">"^(....)"</span>))   <span class="co">#- extraigo los 4 primeros caracteres de NATCODE</span>
ccaa_todas &lt;-<span class="st"> </span>ccaa_todas <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">INECodCCAA =</span> <span class="kw">str_extract</span>(INECodCCAA, <span class="st">"(..)$"</span>))   <span class="co">#- extraigo los 2 ultimos caracteres de INECodCCAA</span></code></pre></div>
<p>Cargo los códigos del INE para las CC.AA y fusiono con los shapes:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># devtools::install_github("perezp44/pjppkgRdata01")  #- personal pkg</span>
<span class="kw">library</span>(pjppkgRdata01) <span class="co">#- personal pkg</span>
INE_prov &lt;-<span class="st">  </span>cod_provincias   
INE_prov &lt;-<span class="st"> </span>INE_prov <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(CODAUTO, CCAA) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()
INE_prov &lt;-<span class="st"> </span>INE_prov <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">INECodCCAA =</span> CODAUTO)
INE_prov &lt;-<span class="st"> </span>INE_prov <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">NombreCCAA =</span> CCAA)
IGN_CCAA_<span class="dv">17</span> &lt;-<span class="st"> </span><span class="kw">left_join</span>(ccaa_todas, INE_prov) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(INECodCCAA, NATCODE, NAMEUNIT, NombreCCAA, <span class="kw">everything</span>())
IGN_CCAA_17s &lt;-<span class="st"> </span>IGN_CCAA_<span class="dv">17</span> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(INECodCCAA, NATCODE, NombreCCAA, geometry)</code></pre></div>
<p>He creado dos objetos que guardaré después en el package que voy a crear: <code>IGN_CCAA_17</code> con 19 filas (una por C.A) y 11 columnas (está toda la información de los ficheros del IGN) y <code>IGN_CCAA_17s</code> (s significa “short”) donde solo dejo 4 columnas (INECodCCAA, NATCODE, NombreCCAA, geometry).</p>
<p>Para ver si lo he hecho ok, hagamos un gráfico</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tmap)
<span class="kw">library</span>(spanishRshapes)
aa &lt;-<span class="st"> </span>IGN_CCAA_17s <span class="op">%&gt;%</span><span class="st">  </span><span class="kw">select</span>(NombreCCAA)
grafico &lt;-<span class="st"> </span><span class="kw">tm_shape</span>(aa, <span class="dt">alpha =</span> <span class="fl">0.3</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">tm_fill</span>(<span class="dt">col =</span> <span class="st">"NombreCCAA"</span>,  <span class="dt">title =</span> <span class="st">"CC.AA."</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">tm_polygons</span>(<span class="dt">border.alpha =</span> <span class="fl">0.6</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">tm_layout</span>(<span class="dt">legend.position =</span> <span class="kw">c</span>(<span class="st">"left"</span>, <span class="st">"top"</span>))
grafico</code></pre></div>
<p><img src="intro-to-spanishrshapes_files/figure-html/unnamed-chunk-9-1.png" width="672"></p>
<p><br></p>
</div>
<div id="lindes-provinciales" class="section level2">
<h2 class="hasAnchor">
<a href="#lindes-provinciales" class="anchor"></a>Lindes provinciales</h2>
<p>Bien, ahora toca arreglar los ficheros con los polígonos de lindes provinciales.</p>
<p>Cargamos los datos, saldrán 50 filas en el fichero de polígonos peninsulares y 2 en Canarias:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aa &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="kw">here</span>(), <span class="st">"./data_IGN/lineas_limite/recintos_provinciales_inspire_peninbal_etrs89/recintos_provinciales_inspire_peninbal_etrs89.shp"</span>)
prov_sf &lt;-<span class="st"> </span><span class="kw">st_read</span>(aa) <span class="co">#- 50 registros en Peninsula</span>
aa &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="kw">here</span>(), <span class="st">"./data_IGN/lineas_limite/recintos_provinciales_inspire_canarias_wgs84/recintos_provinciales_inspire_canarias_wgs84.shp"</span>)
prov_can_sf &lt;-<span class="st"> </span><span class="kw">st_read</span>(aa)  <span class="co">#- 2 registos en Canarias</span></code></pre></div>
<p>Transformamos el CRS de canarias y unimos península y Canarias:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">prov_can_sf&lt;-<span class="st"> </span><span class="kw">st_transform</span>(prov_can_sf, <span class="dv">4258</span>) <span class="co">#- convierto de epsg(SRID):4326   a  epsg(SRID): 4258</span>
<span class="co">#- para unirlos hay q usar rbind(..., deparse.level = 1)</span>
prov_todas &lt;-<span class="st"> </span><span class="kw">rbind</span>(prov_sf, prov_can_sf, <span class="dt">deparse.level =</span> <span class="dv">1</span>) <span class="co">#- 52 registros</span></code></pre></div>
<p>Extraigo códigos provinciales de la variable <code>NATCODE</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># NATCODE de la provincia de Teruel es  34024400000</span>
prov_todas &lt;-<span class="st"> </span>prov_todas <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">INECodProv =</span> <span class="kw">str_extract</span>(NATCODE, <span class="st">"(.......)$"</span>))   <span class="co">#- extraigo los 7 ultimos caracteres de NATCODE</span>
prov_todas &lt;-<span class="st"> </span>prov_todas <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">INECodProv =</span> <span class="kw">str_extract</span>(INECodProv, <span class="st">"^(..)"</span>))   <span class="co">#- extraigo los 2 primeros caracteres de INECodProv</span></code></pre></div>
<p>Fusiono con códigos provinciales del INE:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">INE_prov &lt;-<span class="st">  </span>cod_provincias   
INE_prov &lt;-<span class="st"> </span>INE_prov <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">INECodProv =</span> CPRO)
INE_prov &lt;-<span class="st"> </span>INE_prov <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">NombreProv =</span> PROVINCIA)
INE_prov &lt;-<span class="st"> </span>INE_prov <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">INECodCCAA =</span> CODAUTO)
INE_prov &lt;-<span class="st"> </span>INE_prov <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">NombreCCAA =</span> CCAA)
IGN_prov_<span class="dv">17</span> &lt;-<span class="st"> </span><span class="kw">left_join</span>(prov_todas, INE_prov) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(INECodProv, NATCODE, NAMEUNIT, NombreProv, NombreCCAA, <span class="kw">everything</span>())
IGN_prov_17s &lt;-<span class="st"> </span>IGN_prov_<span class="dv">17</span> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(INECodProv, NATCODE, NombreProv, INECodCCAA, NombreCCAA, geometry)</code></pre></div>
<p>Un gráfico con los lindes provinciales:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tmap)
aa &lt;-<span class="st"> </span>IGN_prov_17s <span class="op">%&gt;%</span><span class="st">  </span><span class="kw">select</span>(NombreProv)
grafico &lt;-<span class="st"> </span><span class="kw">tm_shape</span>(aa, <span class="dt">alpha =</span> <span class="fl">0.3</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">tm_fill</span>(<span class="dt">col =</span> <span class="st">"NombreProv"</span>,  <span class="dt">title =</span> <span class="st">"Provincias"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">tm_polygons</span>(<span class="dt">border.alpha =</span> <span class="fl">0.6</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">tm_layout</span>(<span class="dt">legend.position =</span> <span class="kw">c</span>(<span class="st">"left"</span>, <span class="st">"top"</span>))
grafico</code></pre></div>
<p><img src="intro-to-spanishrshapes_files/figure-html/unnamed-chunk-14-1.png" width="672"></p>
<p><br></p>
<hr>
</div>
<div id="lindes-municipales" class="section level2">
<h2 class="hasAnchor">
<a href="#lindes-municipales" class="anchor"></a>Lindes municipales</h2>
<p>Toca arreglar los ficheros con los polígonos de lindes municipales.</p>
<p>Cargamos los datos. Saldrán 8117 filas en el fichero de polígonos peninsulares y 94 en Canarias:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aa &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="kw">here</span>(), <span class="st">"./data_IGN/lineas_limite/recintos_municipales_inspire_peninbal_etrs89/recintos_municipales_inspire_peninbal_etrs89.shp"</span>)
mun_sf &lt;-<span class="st"> </span><span class="kw">st_read</span>(aa) <span class="co">#- 50 registros en Peninsula</span>
aa &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="kw">here</span>(), <span class="st">"./data_IGN/lineas_limite/recintos_municipales_inspire_canarias_wgs84/recintos_municipales_inspire_canarias_wgs84.shp"</span>)
mun_can_sf &lt;-<span class="st"> </span><span class="kw">st_read</span>(aa)  <span class="co">#- 2 registos en Canarias</span></code></pre></div>
<p>Transformamos el CRS de Canarias y unimos península con Canarias.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mun_can_sf&lt;-<span class="st"> </span><span class="kw">st_transform</span>(mun_can_sf, <span class="dv">4258</span>) <span class="co">#- convierto de epsg(SRID):4326   a  epsg(SRID): 4258</span>
<span class="co">#- para unirlos hay q usar rbind(..., deparse.level = 1)</span>
mun_todas &lt;-<span class="st"> </span><span class="kw">rbind</span>(mun_sf, mun_can_sf, <span class="dt">deparse.level =</span> <span class="dv">1</span>) <span class="co">#- 8211 registros</span></code></pre></div>
<p>Salen 8211 filas. Demasiados!!no hay tantos municipios en Spain!! Lo sé porque hace poco lo he mirado en el INE: en el último fichero que hay en el INE, <strong>a 1 de enero de 2017 habían en España 8124 municipios</strong>. ¿Por qué hay tantos shapes/polígonos/geometrías en el ING? No soy un experto, pero … cerca de mi despacho tengo uno que sí lo es y mirando uno de sus libros <a href="https://www.fbbva.es/publicaciones/cambios-en-la-estructura-y-localizacion-de-la-poblacion-una-vision-de-largo-plazo-1842-2011/">aquí</a> se puede leer (en la página 311):</p>
<blockquote>
<p>La unidad terrotorial básica … es el municipio; sin embargo, se incluyen 84 dominios … que se administran por dos o más ayuntamientos, son los denominados condominios o territorios mancomunados. Tienen un caracter marcadamente historico …. y se concentran en las provincias de Burgos y Navarra.</p>
</blockquote>
<p>En el libro se dice que hay 84 condominios, pero actualmente sólo hay 81. Se pueden identificar a través de la variable <code>NATCODE</code>. El NATCODE de mi pueblo es 34024444177; los últimos 5 dígitos conforman el código INE para mi pueblo: 44177, cuyos 2 primeros dígitos son el código provincial del INE. Bien, pues los territorios mancomunados tienen un código provincial en NATCODE de 53. Podríamos verlos con:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># NATCODE de Pancrudo es 34024444177 filter(NATCODE == 34024444177)</span>
<span class="co"># INECodMuni de Pancrudo es 44177  (o sea, unirlos x los 5 ultimos codigos)</span>
mun_todas &lt;-<span class="st"> </span>mun_todas <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">INECodMuni =</span> <span class="kw">str_extract</span>(NATCODE, <span class="st">"(.....)$"</span>))   <span class="co">#- extraigo los 5 ultimos caracteres de NATCODE</span>
condominios &lt;-<span class="st"> </span>mun_todas <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(<span class="kw">str_detect</span>(INECodMuni, <span class="st">"^53"</span>))  <span class="co">#- 81 shapes q empiezan x 53</span>
no_condominios &lt;-<span class="st"> </span>mun_todas <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">str_detect</span>(INECodMuni, <span class="st">"^53"</span>))  <span class="co">#- 8130 shapes q NO empiezan x 53 (sobran 6 q tienen q ver con los 6 municipios de la Gomera q tienen 2 rows)</span></code></pre></div>
<p>Vamos a ver donde están los territorios mancomunados o condominios:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">virpalette &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"#E41A1C"</span>, <span class="st">"white"</span>)
mun_xx &lt;-<span class="st"> </span>mun_todas <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">Si_condo =</span> <span class="kw">ifelse</span>(<span class="kw">str_detect</span>(INECodMuni, <span class="st">"^53"</span>), <span class="st">"Condominio"</span>, <span class="st">"No"</span>)) 
mun_xxx &lt;-<span class="st"> </span>mun_xx <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(<span class="op">!</span>(<span class="kw">str_detect</span>(INECodMuni, <span class="st">"(^38)|(^35)"</span>)))  <span class="co">#- quito Canarias</span>
ccaa_todas_xxx &lt;-<span class="st"> </span>ccaa_todas <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(<span class="op">!</span>(<span class="kw">str_detect</span>(INECodCCAA, <span class="st">"^05"</span>)))  <span class="co">#- quito Canarias</span>
map_condominios &lt;-<span class="st"> </span><span class="kw">tm_shape</span>(mun_xxx, <span class="dt">alpha =</span> <span class="fl">0.3</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">tm_fill</span>(<span class="dt">col =</span> <span class="st">"Si_condo"</span>, <span class="dt">palette =</span> virpalette, <span class="dt">title =</span> <span class="st">"Territorios mancomunados"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">tm_polygons</span>(<span class="dt">border.alpha =</span> <span class="fl">0.6</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">tm_layout</span>(<span class="dt">legend.position =</span> <span class="kw">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>))
map_condominios &lt;-<span class="st"> </span>map_condominios <span class="op">+</span><span class="st"> </span><span class="kw">tm_shape</span>(ccaa_todas_xxx, <span class="dt">alpha =</span> <span class="fl">0.2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_polygons</span>(<span class="dt">lwd =</span> <span class="fl">1.8</span>, <span class="dt">border.col =</span> <span class="st">"black"</span>, <span class="dt">alpha =</span> <span class="fl">0.2</span>)
map_condominios</code></pre></div>
<p>No se ven muy bien, pero sí, están concentrados en las provincias de Burgos y Navarra. El condominio más grande son las <a href="https://es.wikipedia.org/wiki/Bardenas_Reales">Bardenas Reales</a> en Navarra. Según la Wikipedia:</p>
<blockquote>
<p>El territorio de las Bardenas no pertenece a ningún municipio, con excepción de El Vedado de Eguaras que pertenece al municipio de Valtierra. El resto fue propiedad de la corona, de ahí el apelativo de Reales y en la actualidad es de dominio público siendo propiedad del gobierno de Navarra.</p>
</blockquote>
<p>Los 81 condominios no los voy a quitar, como se pueden filtrar fácilmente los dejaré; PERO es que hay un segundo problema: si quitamos los 81 condominios nos quedarían 8.130 filas/polígonos geometrías, cuando sólo hay 8124 municipios, sobran 6 filas!!!</p>
<p>Después de tirarme de los pelos, descubrí que las seis filas “sobrantes” se debían a que habían seis municipios que tenían dos filas; concretamente esto ocurría en los 6 municipios que tiene la isla de La Gomera.</p>
<p>Mirando un poco más vi que cada uno de los 6 municipios de la Gomera tenía una row para el territorio del municipio en la isla de la Gomera y otro para una serie de “islitas” fuera de la isla de La Gomera; así que tenía varias posibilidades:</p>
<ul>
<li><p>fusionar esas dos shapes (para cada uno de los 6 municipios)</p></li>
<li><p>eliminar las 6 rows con las islitas de La Gomera,</p></li>
<li><p>cambiarles el código provincial y dejarlas en el fichero.</p></li>
</ul>
<p>Al final decidí cambiar el código provincial (de las 6 rows con las islitas de La Gomera) para poder filtralas facilmente pero tenerlas en el fichero per si de cas. Lo hago con el chunk de abajo:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#- identifiqué las rows donde estaban las islitas alrededor de La Gomera </span>
islitas_Gomera &lt;-<span class="st"> </span><span class="kw">c</span>(8156L, 8158L, 8177L, 8193L, 8207L, 8209L) <span class="co">#- están son las 6 rows que voy a poner q su 38 de INECodMuni pase a ser 66</span>
mun_todas &lt;-<span class="st"> </span>mun_todas <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">INECodMuni =</span> <span class="kw">str_extract</span>(NATCODE, <span class="st">"(.....)$"</span>))   <span class="co">#- extraigo los 5 ultimos caracteres de NATCODE</span>
<span class="cf">for</span> (i <span class="cf">in</span> islitas_Gomera) {
  mun_todas<span class="op">$</span>INECodMuni[i]  &lt;-<span class="st"> </span><span class="kw">str_replace</span>(mun_todas<span class="op">$</span>INECodMuni[i] ,<span class="st">"38"</span>, <span class="st">"66"</span>)
}</code></pre></div>
<p>Fusionar con el fichero de códigos INE:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">INE_mun &lt;-<span class="st">  </span>cod_muni_pjp_<span class="dv">17</span>   <span class="co">#- 8124 municipios (1-enero-2017)</span>
IGN_mun_<span class="dv">17</span> &lt;-<span class="st"> </span><span class="kw">left_join</span>(mun_todas, INE_mun) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(INECodMuni, NATCODE, NAMEUNIT, NombreMuni, NombreProv, NombreCCAA, <span class="kw">everything</span>())
IGN_mun_17s &lt;-<span class="st"> </span>IGN_mun_<span class="dv">17</span> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(INECodMuni, NATCODE, INECodProv, INECodCCAA, NombreProv, NombreCCAA, geometry)</code></pre></div>
<p>Un gráfico con los lindes municipales:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tmap)
aa &lt;-<span class="st"> </span>IGN_mun_17s <span class="op">%&gt;%</span><span class="st">  </span><span class="kw">select</span>(NombreCCAA) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(NombreCCAA <span class="op">!=</span><span class="st"> "Canarias"</span>)
grafico &lt;-<span class="st"> </span><span class="kw">tm_shape</span>(aa, <span class="dt">alpha =</span> <span class="fl">0.3</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">tm_fill</span>(<span class="dt">col =</span> <span class="st">"NombreCCAA"</span>,  <span class="dt">title =</span> <span class="st">"Municipios por CCAA"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">tm_polygons</span>(<span class="dt">border.alpha =</span> <span class="fl">0.6</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">tm_layout</span>(<span class="dt">legend.position =</span> <span class="kw">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>))
quitar &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"Canarias"</span>, <span class="st">"Ceuta"</span>, <span class="st">"Melilla"</span>)
bb &lt;-<span class="st"> </span>IGN_CCAA_17s <span class="op">%&gt;%</span><span class="st">  </span><span class="kw">select</span>(NombreCCAA) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(<span class="op">!</span>(NombreCCAA <span class="op">%in%</span><span class="st"> </span>quitar))
grafico &lt;-<span class="st"> </span>grafico <span class="op">+</span><span class="st"> </span><span class="kw">tm_shape</span>(bb, <span class="dt">alpha =</span> <span class="fl">0.2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_polygons</span>(<span class="dt">lwd =</span> <span class="fl">1.8</span>, <span class="dt">border.col =</span> <span class="st">"black"</span>, <span class="dt">alpha =</span> <span class="fl">0.2</span>)

grafico</code></pre></div>
<p><img src="intro-to-spanishrshapes_files/figure-html/unnamed-chunk-22-1.png" width="672"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#intro-y-descarga-del-ign">Intro y descarga del IGN</a></li>
      <li><a href="#lindes-de-cc-aa-">Lindes de CC.AA.</a></li>
      <li><a href="#lindes-provinciales">Lindes provinciales</a></li>
      <li><a href="#lindes-municipales">Lindes municipales</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Pedro J. Perez.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
